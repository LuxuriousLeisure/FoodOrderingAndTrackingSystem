<section id="page-login" class="page">
  <div class="login-shell">
    <a class="back-pill" href="#home" data-route="home">← Back</a>
    <div class="stack">
      <h2 id="loginTitle" style="margin:0 0 4px">Log in</h2>
      <div class="muted" id="postLoginHint"></div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:6px">
        <a class="cta" href="#" id="btnRegister">Register</a>
        <a class="cta" href="#" id="btnLogin">Log in</a>
      </div>

      <form id="registerForm" class="form" style="display:none">
        <div class="muted" id="registerAs">Role: User</div>
        <label>Name<input required></label>
        <label>Email<input type="email" required></label>
        <label>Password<input type="password" required></label>
        <button class="btn primary" type="submit">Create account</button>
      </form>

      <form id="loginForm" class="form">
        <div class="muted" id="loginAs">Role: User</div>
        <label>Email<input type="email" id="loginEmail" required></label>
        <label>Password<input type="password" id="loginPass" required></label>
        <button class="btn primary" type="submit">Log in</button>
        <div class="muted" id="loginError" style="color:#b91c1c"></div>
      </form>
    </div>
  </div>
</section>

<script>
// 登录页面逻辑
document.addEventListener('DOMContentLoaded', () => {
  const regBtn = document.getElementById('btnRegister');
  const logBtn = document.getElementById('btnLogin');
  const regForm = document.getElementById('registerForm');
  const logForm = document.getElementById('loginForm');
  const loginTitle = document.getElementById('loginTitle');
  const loginEmail = document.getElementById('loginEmail');
  const loginPass = document.getElementById('loginPass');
  const loginError = document.getElementById('loginError');
  const authState = document.getElementById('authState');
  
  // 演示账号信息
  const AUTH_DEMOS = {
    user: { email: 'demo.user@example.com', pass: 'demo1234' },
    staff: { email: 'demo.staff@example.com', pass: 'staff1234' }
  };

  let role = 'user';
  let redirectTo = null;
  let pendingRestaurantId = null;
  let pendingAddDish = null;

  // 设置登录模式（登录/注册）
  function setLoginMode(mode) {
    if (mode === 'register') {
      regForm.style.display = 'grid';
      logForm.style.display = 'none';
      loginTitle.textContent = 'Register';
    } else {
      regForm.style.display = 'none';
      logForm.style.display = 'grid';
      loginTitle.textContent = 'Log in';
    }
  }

  // 更新登录提示
  function updatePostLoginHint() {
    const hintEl = document.getElementById('postLoginHint');
    if (!hintEl) return;

    if (redirectTo) {
      const { route, params } = redirectTo;
      const name = route === 'restaurant' ? `restaurant ${params?.id || ''}` : route;
      const addHint = pendingAddDish ? ' and your selected dish will be added to cart.' : '.';
      hintEl.textContent = `After authentication you will be redirected to ${name}${addHint}`;
    } else {
      hintEl.textContent = '';
    }
  }

  // 完成登录
  function finishLogin() {
    window.isLoggedIn = true;
    authState.textContent = `Logged in (${role})`;

    if (redirectTo) {
      const { route, params } = redirectTo;
      const goTo = route === 'restaurant' && params?.id 
        ? `restaurant?id=${params.id}` 
        : route;
      location.hash = goTo;
      redirectTo = null;
    } else {
      location.hash = role === 'staff' ? 'staff' : 'home';
    }
    pendingRestaurantId = null;
    pendingAddDish = null;
  }

  // 绑定事件
  regBtn.addEventListener('click', (e) => {
    e.preventDefault();
    setLoginMode('register');
    updatePostLoginHint();
  });

  logBtn.addEventListener('click', (e) => {
    e.preventDefault();
    setLoginMode('login');
    updatePostLoginHint();
  });

  regForm.addEventListener('submit', (e) => {
    e.preventDefault();
    finishLogin();
  });

  logForm.addEventListener('submit', (e) => {
    e.preventDefault();
    loginError.textContent = '';
    
    const email = loginEmail.value.trim();
    const password = loginPass.value.trim();
    const demo = AUTH_DEMOS[role];

    if (demo && email === demo.email && password === demo.pass) {
      finishLogin();
    } else {
      loginError.textContent = 'Invalid credentials. Try demo.user@example.com / demo1234 (User) or demo.staff@example.com / staff1234 (Staff).';
    }
  });

  // 页面初始化
  if (document.getElementById('page-login').classList.contains('active')) {
    // 从URL参数获取角色
    const params = new URLSearchParams(location.hash.split('?')[1]);
    role = params.get('as') || 'user';
    document.getElementById('registerAs').textContent = `Role: ${role}`;
    document.getElementById('loginAs').textContent = `Role: ${role}`;
    setLoginMode('login');
  }
});
</script>
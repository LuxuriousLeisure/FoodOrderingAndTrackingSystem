<!DOCTYPE html>
<html lang="en">
<head>
	<link rel="stylesheet" href="/css/Project.css">
</head>
<body>
 
 <header>
    <div class="wrap topbar">
      <a class="brand" href="/">
        <img src="/css/Logo.png" width='80' height='60'>
        <strong>Food Ordering System</strong>
      </a>
      <div style="display:flex;gap:8px">

          <a class="pill" href="/login?as=user">User</a>
          <a class="pill" href="/login?as=staff">Staff</a>
      </div>
    </div>
  </header>
<main class="wrap">
<section id="page-login" class="page active">
  <div class="login-shell">
    <a class="back-pill" href="/" data-route="home">← Back</a>
    <div class="stack">
      <h2 id="loginTitle" style="margin:0 0 4px">Log in</h2>
      <div class="muted" id="postLoginHint"></div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:6px">
        <a class="cta" href="#" id="btnRegister">Register</a>
        <a class="cta" href="#" id="btnLogin">Log in</a>
      </div>

      <form id="registerForm" class="form" style="display:none">
        <div class="muted" id="registerAs">Role: User</div>
        <label>Name<input type="text" name="name" required></label>
        <label>Email<input type="email" name="email" required></label>
        <label>Password<input type="password" name="password" required></label>
        <!-- 新增隐藏字段传递角色信息 -->
        <input type="hidden" name="role" id="registerRole" value="user">
        <button class="btn primary" type="submit">Create account</button>
      </form>

      <form id="loginForm" class="form" action="/login" method="POST">
        <div class="muted" id="loginAs">Role: User</div>
        <!-- 新增name属性，与后端req.body对应 -->
        <label>Email<input type="email" id="loginEmail" name="email" required></label>
        <label>Password<input type="password" id="loginPass" name="password" required></label>
        <!-- 新增隐藏字段传递角色，与注册保持一致 -->
         <input type="hidden" name="role" id="loginRole" value="user">
        <button class="btn primary" type="submit">Log in</button>
        <div class="muted" id="loginError" style="color:#b91c1c"></div>
      </form>
    </div>
  </div>
</section>
</main>
</body>


<script>
// 登录页面逻辑
document.addEventListener('DOMContentLoaded', () => {
  const regBtn = document.getElementById('btnRegister');
  const logBtn = document.getElementById('btnLogin');
  const regForm = document.getElementById('registerForm');
  const logForm = document.getElementById('loginForm');
  const loginTitle = document.getElementById('loginTitle');
  const loginEmail = document.getElementById('loginEmail');
  const loginPass = document.getElementById('loginPass');
  const loginError = document.getElementById('loginError');
  const authState = document.getElementById('authState');
  
  // 演示账号信息
  const AUTH_DEMOS = {
    user: { email: 'demo.user@example.com', pass: 'demo1234' },
    staff: { email: 'demo.staff@example.com', pass: 'staff1234' }
  };

  let role = 'user';
  let redirectTo = null;
  let pendingRestaurantId = null;
  let pendingAddDish = null;

  // 设置登录模式（登录/注册）
  function setLoginMode(mode) {
    if (mode === 'register') {
      regForm.style.display = 'grid';
      logForm.style.display = 'none';
      loginTitle.textContent = 'Register';
    } else {
      regForm.style.display = 'none';
      logForm.style.display = 'grid';
      loginTitle.textContent = 'Log in';
    }
  }

  // 更新登录提示
  function updatePostLoginHint() {
    const hintEl = document.getElementById('postLoginHint');
    if (!hintEl) return;

    if (redirectTo) {
      const { route, params } = redirectTo;
      const name = route === 'restaurant' ? `restaurant ${params?.id || ''}` : route;
      const addHint = pendingAddDish ? ' and your selected dish will be added to cart.' : '.';
      hintEl.textContent = `After authentication you will be redirected to ${name}${addHint}`;
    } else {
      hintEl.textContent = '';
    }
  }

  // 完成登录
  function finishLogin() {
    window.isLoggedIn = true;
    authState.textContent = `Logged in (${role})`;

    if (redirectTo) {
      const { route, params } = redirectTo;
      const goTo = route === 'restaurant' && params?.id 
        ? `restaurant?id=${params.id}` 
        : route;
      location.hash = goTo;
      redirectTo = null;
    } else {
      location.hash = role === 'staff' ? 'staff' : 'home';
    }
    pendingRestaurantId = null;
    pendingAddDish = null;
  }

  // 绑定事件
  regBtn.addEventListener('click', (e) => {
    e.preventDefault();
    setLoginMode('register');
    updatePostLoginHint();
  });

  logBtn.addEventListener('click', (e) => {
    e.preventDefault();
    setLoginMode('login');
    updatePostLoginHint();
  });

  // regForm.addEventListener('submit', (e) => {
  //   e.preventDefault();
  //   finishLogin();
  // });
  // 替换原regForm.addEventListener('submit'...)部分
  regForm.addEventListener('submit', async (e) => {
    e.preventDefault(); // 保留阻止默认行为，使用AJAX提交以优化体验
  
    // 获取表单数据
    const formData = new FormData(regForm);
    const data = Object.fromEntries(formData.entries());
  
    try {
      // 发送注册请求到后端
      const response = await fetch('/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
       body: new URLSearchParams(data)
      });
      
      if (response.ok) {
        // 注册成功后跳转（后端会处理session并 redirect）
        window.location.href = await response.url;
      } else {
        // 显示后端返回的错误信息
        const error = await response.text();
        throw new Error(error || 'Registration failed');
      }
    } catch (err) {
      // 显示错误提示（可在表单中添加错误提示元素）
      alert(err.message);
    }
  });

  // logForm.addEventListener('submit', (e) => {
  //   e.preventDefault();
  //   loginError.textContent = '';
    
  //   const email = loginEmail.value.trim();
  //   const password = loginPass.value.trim();
  //   const demo = AUTH_DEMOS[role];

  //   if (demo && email === demo.email && password === demo.pass) {
  //     finishLogin();
  //   } else {
  //     loginError.textContent = 'Invalid credentials. Try demo.user@example.com / demo1234 (User) or demo.staff@example.com / staff1234 (Staff).';
  //   }
  // });
  // 替换原logForm.addEventListener('submit'...)部分
  logForm.addEventListener('submit', async (e) => {
    e.preventDefault(); // 阻止默认提交，使用AJAX请求
    loginError.textContent = '';
    
    const email = loginEmail.value.trim();
    const password = loginPass.value.trim();
    const role = document.getElementById('loginRole').value;

    try {
      // 发送登录请求到后端
      const response = await fetch('/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ email, password, role })
      });

      if (response.ok) {
        // 登录成功，跳转至首页或之前的页面
        window.location.href = await response.url;
      } else {
        // 显示后端返回的错误信息（如密码错误、用户不存在等）
        const error = await response.text();
        loginError.textContent = error || 'Invalid credentials';
      }
    } catch (err) {
      loginError.textContent = 'Login failed. Please try again.';
    }
  });


  // 页面初始化
  if (document.getElementById('page-login').classList.contains('active')) {
    // 从URL参数获取角色
    const params = new URLSearchParams(location.hash.split('?')[1]);
    role = params.get('as') || 'user';
    document.getElementById('registerAs').textContent = `Role: ${role}`;
    document.getElementById('loginAs').textContent = `Role: ${role}`;
    setLoginMode('login');
  }
});
</script>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Order Tracking</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="/styles.css">

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />

    <style>#map { width: 100%; height: 380px; border-radius: 12px; }</style>
</head>

<body>

<div class="wrap">
    <h1 class="ink">Track Your Order</h1>
    <p class="muted">Your driver is on the way! Live location and progress are shown below.</p>

    <div class="layout">
        <div class="card">

            <h2 class="ink">Live Map</h2>
            <div id="map"></div>

            <div class="card" style="margin-top:16px;">
                <h3 class="ink">Estimated Arrival Time</h3>
                <p id="eta" class="ink" style="font-size:1.2rem;font-weight:700;">-- mins</p>
            </div>

            <div class="card" style="margin-top:16px;">
                <h3 class="ink">Order Status</h3>

                <div style="background:#f0f0f0;width:100%;height:18px;border-radius:12px;overflow:hidden;">
                    <div id="status-bar" style="height:100%;width:0%;background:var(--brand);transition:width .4s;"></div>
                </div>

                <p id="status-text" class="ink" style="margin-top:8px;">
                    <%= order.status %>
                </p>

                <div style="margin-top:12px;">
                    <button class="btn primary" id="driver-update-btn">Driver: Update Status</button>
                </div>
            </div>
        </div>

        <!-- ORDER SUMMARY -->
        <div class="cart">
            <h2 class="ink">Order Summary</h2>

            <ul id="orderItems">
                <% order.items.forEach(item => { %>
                    <li>
                        <span><%= item.name %></span>
                        <strong class="price">$<%= item.price %></strong>
                    </li>
                <% }) %>
            </ul>

            <div class="total">
                <span>Total</span>
                <strong class="price">$<%= order.total %></strong>
            </div>
        </div>

    </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

<script>
/* ---------- MAP DATA FROM DB ---------- */
let driver = [<%= driver.lat %>, <%= driver.lng %>];
let restaurant = [<%= restaurant.lat %>, <%= restaurant.lng %>];
let user = [<%= user.lat %>, <%= user.lng %>];
let status = "<%= order.status %>";

/* ---------- MAP INITIALISE ---------- */
const map = L.map('map').setView(restaurant, 14);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

L.marker(restaurant).addTo(map).bindPopup("Restaurant");
L.marker(user).addTo(map).bindPopup("User");
let driverMarker = L.marker(driver).addTo(map).bindPopup("Driver");

let routeControl = L.Routing.control({
    waypoints: [],
    addWaypoints: false,
    draggableWaypoints: false,
    createMarker: () => null,
    lineOptions: { styles: [{ color: "#0078ff", weight: 4 }] }
}).addTo(map);

const router = L.Routing.osrmv1();

/* ---------- ETA + ROUTE ---------- */
function updateRouteAndEta() {
    if (status === "to_restaurant") {
        routeControl.setWaypoints([driver, restaurant]);

        routeControl.on("routesfound", e => {
            const t1 = e.routes[0].summary.totalTime;

            router.route([
                L.Routing.waypoint(restaurant),
                L.Routing.waypoint(user)
            ], (err, r) => {
                const t2 = r[0].summary.totalTime;
                document.getElementById("eta").textContent = Math.round((t1+t2)/60) + " mins";
            });
        });

    } else if (status === "to_user" || status === "picked_up") {

        routeControl.setWaypoints([driver, user]);

        routeControl.on("routesfound", e => {
            const mins = Math.round(e.routes[0].summary.totalTime / 60);
            document.getElementById("eta").textContent = mins + " mins";
        });

    } else if (status === "delivered") {
        document.getElementById("eta").textContent = "Delivered!";
    }
}

updateRouteAndEta();
</script>

</body>
</html>
